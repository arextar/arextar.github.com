(function(e){function i(e){var t=this;this.worker=e,this.events={},this.fns={},e.onmessage=function(e){t._handleMessage(e.data)}}function s(e,t){return function(){t.emit("__call",e,r.call(arguments))}}var t=this.wrench=new i(self),n=1,r=[].slice;i.prototype._decodeArgs=function(e){for(var t=0;t<e.length;t++)typeof e[t]=="string"&&/^__wrenchFunction/.test(e[t])&&(e[t]=s(e[t],this));return e},i.prototype._encodeArgs=function(e){for(var t=0;t<e.length;t++)if(typeof e[t]=="function"){var r="__wrenchFunction"+n++;this.fns[r]=e[t],e[t]=r}return e},i.prototype._handleMessage=function(e){typeof e=="string"&&(e=JSON.parse(e));if(e.type==="__call"){this.fns[e.args[0]].apply(this,e.args[1]);return}if(e.type==="__log"){window.console&&console.log.apply(console,e.args);return}var t=this.events[e.type];if(!t)return;var n=this._decodeArgs(e.args);if(typeof t=="function")return t.apply(this,n);for(var r=0;r<t.length;r++)t[r].apply(this,n)},i.prototype.emit=function(e,t,n){var i=arguments.length;this.worker.postMessage({type:e,args:i<2?[]:this._encodeArgs(i<3?[t]:i<4?[t,n]:r.call(arguments,1))})},i.prototype.on=function(e,t){var n=this.events,r=typeof n[e];r==="undefined"?n[e]=t:r==="function"?n[e]=[n[e],t]:n[e].push(t)},i.prototype.log=function(e,t){var n=arguments.length;this.worker.postMessage({type:"__log",args:n<1?[]:n<2?[e]:n<3?[e,t]:r.call(arguments)})};var o=Function.prototype.bind||function(e,t,n){var i=this,s=arguments.length,o=s<2?[]:s<3?[t]:s<4?[t,n]:r.call(arguments,1);return function(){i.apply(e,o.concat(r.call(arguments)))}};t.each=function(t,n,r){if(e){for(var i=0;i<t.length;i++)n(t[i],i,t);r&&r()}else{for(var i=0;i<t.length;i++)setTimeout(o.call(n,null,t[i],i,t),1);r&&setTimeout(r,1)}},t.eachAsync=function(t,n,r){if(e)for(var i=0,s=1;i<t.length;i++)n(t[i],function(){s++,s===t.length&&r()},i,t);else for(var i=0,s=1;i<t.length;i++)setTimeout(o.call(n,null,t[i],function(){s++,s===t.length&&r()},i,t),1)},t.filter=function(e,n,r){var i=[],s=0;t.each(e,function(t,r){n(t,r,e)&&(i[s++]=t)},function(){r&&r(i)})},t.map=function(e,n,r){var i=[];t.each(e,function(t,r){i[r]=n(t,r,e)},function(){r&&r(i)})},t.get=function(e,t,n){typeof t=="function"&&(n=t,t="text");var r=new XMLHttpRequest;r.open("GET",e),r.onreadystatechange=function(){if(r.readyState===4){var e=r.responseText;r=null,t==="json"&&(e=JSON.parse(e)),n(e)}},r.send()}})(typeof window=="undefined")